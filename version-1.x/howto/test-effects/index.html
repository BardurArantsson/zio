<!doctype html>
<html class="docs-version-1.x" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="search" type="application/opensearchdescription+xml" title="ZIO" href="/opensearch.xml">
<link rel="stylesheet" href="/css/prism/prism-material-dark.css"><title data-react-helmet="true">How to Test effects? | ZIO</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zio.dev/version-1.x/howto/test-effects"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="1.x"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-1.x"><meta data-react-helmet="true" property="og:title" content="How to Test effects? | ZIO"><meta data-react-helmet="true" name="description" content="How zio-test was designed"><meta data-react-helmet="true" property="og:description" content="How zio-test was designed"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://zio.dev/version-1.x/howto/test-effects"><link data-react-helmet="true" rel="alternate" href="https://zio.dev/version-1.x/howto/test-effects" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zio.dev/version-1.x/howto/test-effects" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.f4d50625.css">
<link rel="preload" href="/assets/js/runtime~main.a9287c7c.js" as="script">
<link rel="preload" href="/assets/js/main.d278da23.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/navbar_brand.png" alt="ZIO" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/navbar_brand.png" alt="ZIO" class="themedImage_TMUO themedImage--dark_uzRr"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/version-1.x/overview/overview_index">Overview</a><a class="navbar__item navbar__link" href="/version-1.x/datatypes/index">Data Types</a><a class="navbar__item navbar__link" href="/version-1.x/usecases/usecases_index">Use Cases</a><a class="navbar__item navbar__link" href="/version-1.x/howto/index">How to</a><a class="navbar__item navbar__link" href="/version-1.x/resources/index">Resources</a><a class="navbar__item navbar__link" href="/version-1.x/about/about_index">About</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/version-1.x/overview/overview_index">ZIO 1.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/next/howto/test-effects">ZIO 2.x (WIP)</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/version-1.x/howto/test-effects">ZIO 1.x</a></li></ul></div><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">How to</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/howto/use-test-assertions">How to Use Test Assertions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/version-1.x/howto/test-effects">How to Test effects?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/howto/mock-services">How to Mock Services?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/howto/handle-errors">How to Handle Errors?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/howto/access-system-information">How to Access System Information?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/howto/use-zio-macros">How to use ZIO Macros?</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Interop</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Migrate</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->ZIO 1.x</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How to Test effects?</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="how-zio-test-was-designed">How zio-test was designed<a aria-hidden="true" class="hash-link" href="#how-zio-test-was-designed" title="Direct link to heading">â€‹</a></h2><p><code>zio-test</code> is designed around the idea of making tests first-class objects. What it means is that tests (and other accompanying concepts like assertions) become ordinary values that can be passed around, transformed and composed together. This approach allows for greater flexibility comparing to some other testing frameworks where tests and additional logic around tests had to be put into callbacks so that framework could make use of them. This approach also fits better with other <code>ZIO</code> concepts like <code>ZManaged</code> which can only be used within a scoped block of code. This also created a mismatch between <code>BeforeAll</code>, <code>AfterAll</code> callback-like methods when there were resources that should be opened and closed during test suite execution.
Another thing worth pointing out is that tests being values, are also effects. Implications of this design are far reaching. First of all well known problem of testing asynchronous value is gone. Whereas in other frameworks you have to somehow &quot;run&quot; your effects
and at best wrap them in <code>scala.util.Future</code> because blocking would eliminate running on ScalaJS, <code>zio-test</code> expects you to create <code>ZIO</code> objects. There is no need for indirect transformations from one wrapping object to another. Second, because our tests are ordinary <code>ZIO</code> values we don&#x27;t need to turn to testing framework for things like retries, timeouts and resource management. We can solve all those problems with full richness of functions that <code>ZIO</code> exposes.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="constructing-tests">Constructing tests<a aria-hidden="true" class="hash-link" href="#constructing-tests" title="Direct link to heading">â€‹</a></h2><p>All below code assumes that you have imported <code>zio.test._</code></p><p>The backbone of <code>zio-test</code> is the <code>Spec[L, T]</code> class. Every spec is labeled with <code>L</code> and can be a suite which contains other specs or a test of type <code>T</code>.</p><p>The most common and easy way to create suites is to use <code>suite</code> function. For testing of pure functions there is <code>test</code> function and for effectful testing there is <code>testM</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment.Live</span><br></span><span class="token-line"><span class="token plain">import zio.clock.nanoTime</span><br></span><span class="token-line"><span class="token plain">import Assertion.isGreaterThan</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val clockSuite = suite(&quot;clock&quot;) (</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;time is non-zero&quot;) {</span><br></span><span class="token-line"><span class="token plain">    assertM(Live.live(nanoTime))(isGreaterThan(0L))</span><br></span><span class="token-line"><span class="token plain">  }</span><br></span><span class="token-line"><span class="token plain">)</span><br></span><span class="token-line"><span class="token plain">// clockSuite: Spec[Live, TestFailure[Nothing], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;clock&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;time is non-zero&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,21)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           )</span><br></span><span class="token-line"><span class="token plain">//         )</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see the whole suite was assigned to <code>clockSuite</code> val. As it was said suites can contain other suites so we can aggregate them as much as needed. Example, we can have multiple suites that test external HTTP apis and one big suite that will aggregate them all.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import Assertion._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val paymentProviderABCSuite  = suite(&quot;ABC payment provider tests&quot;) {test(&quot;Your test&quot;)(assert(&quot;Your value&quot;)(Assertion.isNonEmptyString))}</span><br></span><span class="token-line"><span class="token plain">// paymentProviderABCSuite: Spec[Any, TestFailure[Nothing], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;ABC payment provider tests&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;Your test&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,36)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           )</span><br></span><span class="token-line"><span class="token plain">//         )</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span><span class="token-line"><span class="token plain">val paymentProviderXYZSuite  = suite(&quot;XYZ payment provider tests&quot;) {test(&quot;Your other test&quot;)(assert(&quot;Your other value&quot;)(Assertion.isNonEmptyString))}</span><br></span><span class="token-line"><span class="token plain">// paymentProviderXYZSuite: Spec[Any, TestFailure[Nothing], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;XYZ payment provider tests&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;Your other test&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,39)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           )</span><br></span><span class="token-line"><span class="token plain">//         )</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span><span class="token-line"><span class="token plain">val allPaymentProvidersTests = suite(&quot;All payment providers tests&quot;)(paymentProviderABCSuite, paymentProviderXYZSuite)</span><br></span><span class="token-line"><span class="token plain">// allPaymentProvidersTests: Spec[Any, TestFailure[Nothing], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;All payment providers tests&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;ABC payment provider tests&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//                   specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//                     Spec(</span><br></span><span class="token-line"><span class="token plain">//                       caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//                         label = &quot;Your test&quot;,</span><br></span><span class="token-line"><span class="token plain">//                         spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                           caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                             test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                             annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,36)))</span><br></span><span class="token-line"><span class="token plain">//                           )</span><br></span><span class="token-line"><span class="token plain">//                         )</span><br></span><span class="token-line"><span class="token plain">//                       )</span><br></span><span class="token-line"><span class="token plain">//                     )</span><br></span><span class="token-line"><span class="token plain">//                   )</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           ),</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;XYZ payment provider tests&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//                   specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//                     Spec(</span><br></span><span class="token-line"><span class="token plain">//                       caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//                         label = &quot;Your other test&quot;,</span><br></span><span class="token-line"><span class="token plain">//                         spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                           caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                             test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                             annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,39)))</span><br></span><span class="token-line"><span class="token plain">//                           )</span><br></span><span class="token-line"><span class="token plain">//                         )</span><br></span><span class="token-line"><span class="token plain">//                       )</span><br></span><span class="token-line"><span class="token plain">//                     )</span><br></span><span class="token-line"><span class="token plain">//                   )</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">// ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Real tests that run some logic and return testing result are created mostly with <code>testM</code> function. It expects two arguments, first one that will be the label of test
which will be used for visual reporting back to the user and an assertion of type
<code>ZIO[R, E, TestResult]</code>. This means writing test in <code>zio-test</code> mostly gets down to creating a <code>ZIO</code> object that
will produce <code>TestResult</code>. There is another variant of function for creating test that are pure called simply <code>test</code>.
It expects a thunk of code that will just return a <code>TestResult</code> without packing it into <code>ZIO</code>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="assertions---creating-testresults">Assertions - creating TestResults<a aria-hidden="true" class="hash-link" href="#assertions---creating-testresults" title="Direct link to heading">â€‹</a></h3><p>As it was already mentioned tests should return <code>TestResult</code>. The most common way to produce a <code>TestResult</code>
is to resort to <code>assert</code> or its effectful counterpart <code>assertM</code>. Both of them accept a value of type <code>A</code> (effectful version wrapped in a <code>ZIO</code>) and an <code>Assertion[A]</code>.
To create <code>Assertion[A]</code> object one can use functions defined under <code>zio.test.Assertion</code>. There are already a number
of useful assertions predefined like <code>equalTo</code>, <code>isFalse</code>, <code>isTrue</code>, <code>contains</code>, <code>throws</code> and more.
What is really useful in assertions is that they behave like boolean values and can be composed with operators
known from operating on boolean values like and (<code>&amp;&amp;</code>), or (<code>||</code>), negation (<code>negate</code>).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test.Assertion</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val assertionForString: Assertion[String] = Assertion.containsString(&quot;Foo&quot;) &amp;&amp; Assertion.endsWithString(&quot;Bar&quot;)</span><br></span><span class="token-line"><span class="token plain">// assertionForString: Assertion[String] = (containsString(Foo) &amp;&amp; endsWithString(Bar))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>What&#x27;s more, assertions also compose with each other allowing for doing rich diffs not only simple value to value comparison.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test.Assertion.{isRight, isSome,equalTo, hasField}</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">test(&quot;Check assertions&quot;) {</span><br></span><span class="token-line"><span class="token plain">  assert(Right(Some(2)))(isRight(isSome(equalTo(2))))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res0: ZSpec[Any, Nothing] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;Check assertions&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,60)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here we&#x27;re checking deeply nested values inside an <code>Either</code> and <code>Option</code>. Because <code>Assertion</code>s compose this is not a problem
all layers are being peeled off tested for condition until final value is reached.
Here the expression <code>Right(Some(2))</code> is of type <code>Either[Any, Option[Int]]</code>and our assertion <code>isRight(isSome(equalTo(2)))</code>
is of type <code>Assertion[Either[Any, Option[Int]]]</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.test.Assertion.{isRight, isSome,equalTo, isGreaterThanEqualTo, not, hasField}</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">final case class Address(country:String, city:String)</span><br></span><span class="token-line"><span class="token plain">final case class User(name:String, age:Int, address: Address)</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">test(&quot;Rich checking&quot;) {</span><br></span><span class="token-line"><span class="token plain">  assert(</span><br></span><span class="token-line"><span class="token plain">    User(&quot;Jonny&quot;, 26, Address(&quot;Denmark&quot;, &quot;Copenhagen&quot;))</span><br></span><span class="token-line"><span class="token plain">  )(</span><br></span><span class="token-line"><span class="token plain">    hasField(&quot;age&quot;, (u:User) =&gt; u.age, isGreaterThanEqualTo(18)) &amp;&amp;</span><br></span><span class="token-line"><span class="token plain">    hasField(&quot;country&quot;, (u:User) =&gt; u.address.country, not(equalTo(&quot;USA&quot;)))</span><br></span><span class="token-line"><span class="token plain">  )</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res2: ZSpec[Any, Nothing] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;Rich checking&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,83)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There is also an easy way to test object&#x27;s data for certain assertions with <code>hasField</code> which accepts besides a name, a mapping function from object to its tested property and <code>Assertion</code> object which will validate this property. Here our test checks if a person has at least 18 years and is not from USA. What is nice about those tests is that, test reporters will tell you exactly which assertion was broken. Let&#x27;s say we would change <code>isGreaterThanEqualTo(18)</code> to <code>isGreaterThanEqualTo(40)</code> which will fail. Printout
on console will be a nice detailed text explaining what exactly went wrong:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token punctuation">[</span><span class="token plain">info</span><span class="token punctuation">]</span><span class="token plain">       User</span><span class="token punctuation">(</span><span class="token plain">Jonny,26,Address</span><span class="token punctuation">(</span><span class="token plain">Denmark,Copenhagen</span><span class="token punctuation">))</span><span class="token plain"> did not satisfy </span><span class="token punctuation">(</span><span class="token plain">hasField</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token plain">, _.age, isGreaterThanEqualTo</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">))</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> hasField</span><span class="token punctuation">(</span><span class="token string">&quot;country&quot;</span><span class="token plain">, _.country, not</span><span class="token punctuation">(</span><span class="token plain">equalTo</span><span class="token punctuation">(</span><span class="token plain">USA</span><span class="token punctuation">))</span><span class="token punctuation">))</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token plain">info</span><span class="token punctuation">]</span><span class="token plain">       </span><span class="token number">26</span><span class="token plain"> did not satisfy isGreaterThanEqualTo</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Having this all in mind probably the most common and also most readable way of structuring tests is to pass
a for-comprehension to <code>testM</code> function and yield a call to <code>assert</code> function.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio._</span><br></span><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import Assertion._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">testM(&quot;Semaphore should expose available number of permits&quot;) {</span><br></span><span class="token-line"><span class="token plain">  for {</span><br></span><span class="token-line"><span class="token plain">    s         &lt;- Semaphore.make(1L)</span><br></span><span class="token-line"><span class="token plain">    permits   &lt;- s.available</span><br></span><span class="token-line"><span class="token plain">  } yield assert(permits)(equalTo(1L))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res3: ZSpec[Any, Nothing] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;Semaphore should expose available number of permits&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,105)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="running-tests">Running tests<a aria-hidden="true" class="hash-link" href="#running-tests" title="Direct link to heading">â€‹</a></h3><p>When all of our tests are constructed, we need to have a way to actually execute them. Your first stop is the <code>zio.test.DefaultRunnableSpec</code> which accepts a single suite that will be executed. A single suite might seem to be limiting but as it was already said suites can hold any number of other suites. You may structure your tests like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.clock.nanoTime</span><br></span><span class="token-line"><span class="token plain">import Assertion._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val suite1 = suite(&quot;suite1&quot;) (</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;s1.t1&quot;) {assertM(nanoTime)(isGreaterThanEqualTo(0L))},</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;s1.t2&quot;) {assertM(nanoTime)(isGreaterThanEqualTo(0L))}</span><br></span><span class="token-line"><span class="token plain">)</span><br></span><span class="token-line"><span class="token plain">// suite1: Spec[clock.package.Clock, TestFailure[Nothing], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;suite1&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;s1.t1&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,126)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           ),</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;s1.t2&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,127)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           )</span><br></span><span class="token-line"><span class="token plain">//         )</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span><span class="token-line"><span class="token plain">val suite2 = suite(&quot;suite2&quot;) (</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;s2.t1&quot;) {assertM(nanoTime)(isGreaterThanEqualTo(0L))},</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;s2.t2&quot;) {assertM(nanoTime)(isGreaterThanEqualTo(0L))},</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;s2.t3&quot;) {assertM(nanoTime)(isGreaterThanEqualTo(0L))}</span><br></span><span class="token-line"><span class="token plain">)</span><br></span><span class="token-line"><span class="token plain">// suite2: Spec[clock.package.Clock, TestFailure[Nothing], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;suite2&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;s2.t1&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,132)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           ),</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;s2.t2&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,133)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           ),</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;s2.t3&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,134)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           )</span><br></span><span class="token-line"><span class="token plain">//         )</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span><span class="token-line"><span class="token plain">val suite3 = suite(&quot;suite3&quot;) (</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;s3.t1&quot;) {assertM(nanoTime)(isGreaterThanEqualTo(0L))}</span><br></span><span class="token-line"><span class="token plain">)</span><br></span><span class="token-line"><span class="token plain">// suite3: Spec[clock.package.Clock, TestFailure[Nothing], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;suite3&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;s3.t1&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,139)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           )</span><br></span><span class="token-line"><span class="token plain">//         )</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">object AllSuites extends DefaultRunnableSpec {</span><br></span><span class="token-line"><span class="token plain">  def spec = suite(&quot;All tests&quot;)(suite1, suite2, suite3)</span><br></span><span class="token-line"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>DefaultRunnableSpec</code> is very similar in its logic of operations to <code>zio.App</code>. Instead of providing one <code>ZIO</code> application
at the end of the world we provide a suite that can be a tree of other suites and tests. Another resemblance is that <code>DefaultRunnableSpec</code> provides an Environment. Here it is an instance of <code>TestEnvironment</code> which helps us with controlling our systems infrastructure. More info on using test environment can be found in sections below.
Just like with <code>zio.App</code> where at the very end an instance of <code>ZIO[R,E,A]</code> is expected where <code>R</code> can be at maximum of type <code>Environment</code> in <code>DefaultRunnableSpec</code> <code>R</code> cannot be more than <code>TestEnvironment</code>. So just like in normal application if our
<code>R</code> is composed of some other modules we need to provide them first before test can be executed. How can we provide our dependencies?
Here again the design of <code>zio-test</code> shines. Since our tests are ordinary values we can just transform them with a call to <code>mapTest</code>.
It accepts a lambda of type <code>ZIO[R with TestSystem, TestFailure[Throwable], TestSuccess[Unit] ] =&gt; T1</code>. Without getting into too much details about types we can see that our lambda argument is a test instance (<code>ZIO</code>) that expects an environment of type <code>R with TestSystem</code>. This is no different from normal usage of ZIO in <code>zio.App</code>. We can use the same <code>provide</code>, <code>provideSome</code> methods to provide modules which <code>DefaultRunnableSpec</code> cannot provide itself as those are users modules. When all dependencies are provided we can run our tests in two ways. If we added <code>zio-test-sbt</code> to our dependencies and <code>zio.test.sbt.TestFramework</code> to SBT&#x27;s <code>testFrameworks</code> our tests should be automatically picked up by SBT on invocation of <code>test</code>. However if we&#x27;re not using SBT or have some other special needs <code>DefaultRunnableSpec</code> has a <code>main</code> method which can be invoked directly or with SBTs <code>test:run</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sbt"><pre tabindex="0" class="prism-code language-sbt codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">libraryDependencies ++= Seq(</span><br></span><span class="token-line"><span class="token plain">  &quot;dev.zio&quot; %% &quot;zio-test&quot;     % zioVersion % &quot;test&quot;,</span><br></span><span class="token-line"><span class="token plain">  &quot;dev.zio&quot; %% &quot;zio-test-sbt&quot; % zioVersion % &quot;test&quot;</span><br></span><span class="token-line"><span class="token plain">),</span><br></span><span class="token-line"><span class="token plain">testFrameworks += new TestFramework(&quot;zio.test.sbt.ZTestFramework&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="using-test-environment">Using Test Environment<a aria-hidden="true" class="hash-link" href="#using-test-environment" title="Direct link to heading">â€‹</a></h2><p>What we expect from tests (at least those that we consider unit tests) is to be stable i.e. consecutive runs should yield the same results and take
more or less the same amount of time. Biggest source of complexity during testing comes from external services which we cannot control like external
payment APIs, object storages, http APIs etc. It is normal to hide these kind of services behind an interface and provide test instances to regain
control and determinism. However there is another source of complexity that comes from the local infrastructure that is also hard to control without building prior abstractions. Things like stdin/stdout, clocks, random generators, schedulers can make writing tests hard or even impossible. Fortunately ZIO abstracted most of it in its runtime under <code>Environment</code> type. Thanks to this design <code>zio-test</code> could easily provide its own implementation named <code>TestEnvironment</code> which gives you test implementations of mentioned infrastructure. In most of the cases when you&#x27;ll be using <code>ZIO</code>s <code>testM</code> test implementations are already created and should be controlled by exposed functions on companion object. If for some reason you would like to provide custom environment or are using other testing framework but still want to use test environment there are <code>make</code> functions on companion objects of test modules where you can construct your own.</p><p>It is easy to accidentally use different test instances at the same time.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment.TestClock</span><br></span><span class="token-line"><span class="token plain">import Assertion._</span><br></span><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">testM(&quot;`acquire` doesn&#x27;t leak permits upon cancellation&quot;) {</span><br></span><span class="token-line"><span class="token plain">  for {</span><br></span><span class="token-line"><span class="token plain">      testClock &lt;- TestClock.makeTest(TestClock.DefaultData)</span><br></span><span class="token-line"><span class="token plain">      s         &lt;- Semaphore.make(1L)</span><br></span><span class="token-line"><span class="token plain">      sf        &lt;- s.acquireN(2).timeout(1.millisecond).either.fork</span><br></span><span class="token-line"><span class="token plain">      _         &lt;- testClock.adjust(1.second)</span><br></span><span class="token-line"><span class="token plain">      _         &lt;- sf.join</span><br></span><span class="token-line"><span class="token plain">      _         &lt;- s.release</span><br></span><span class="token-line"><span class="token plain">      permits   &lt;- s.available</span><br></span><span class="token-line"><span class="token plain">  } yield assert(permits, equalTo(2L))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Above code doesn&#x27;t work. We created a new <code>TestClock</code> instance and are correctly adjusting its time. What might be surprising is that call to <code>timeout</code> will use the <code>TestClock</code> provided by the <code>TestEnvironment</code> not our <code>testClock</code> instance. It easy to know why when you look at the signature of <code>timeout</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.duration.Duration</span><br></span><span class="token-line"><span class="token plain">import zio.clock.Clock</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">sealed trait ZIO[-R, +E, +A] extends Serializable { self =&gt;</span><br></span><span class="token-line"><span class="token plain">    /* All other method declarations in this trait ignored to avoid clutter */</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">    def timeout(d: Duration): ZIO[R with Clock, E, Option[A]]</span><br></span><span class="token-line"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The returned type is <code>ZIO[R with Clock, E, Option[A]]</code> where our environment is &quot;some R plus a Clock&quot;.
Before running this <code>Clock</code> has to be provided and the framework provides the Clock from the <code>TestEnvironment</code> not our instance variable as it is not aware that we created it.</p><p>If you need to provide real implementations instead of the test instances to some part of your tests there is a <code>live</code> method which will transform your <code>ZIO[R, E, A]</code> to <code>ZIO[Live[R], E, A]</code>. Going from <code>R</code> to <code>Live[R]</code> instructs the framework that we really want to be provided with live implementations.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="testing-random">Testing Random<a aria-hidden="true" class="hash-link" href="#testing-random" title="Direct link to heading">â€‹</a></h3><p>When working with randomness testing might be hard because the inputs to the tested function change on every invocation so our code behave in a indeterministic way. Precisely because of this reason <code>ZIO</code> exposes <code>TestRandom</code> module which allows for fully deterministic testing of code
that deals with Randomness.
<code>TestRandom</code> can operate in two modes based on needed use case. In first mode it is a purely functional pseudo-random number generator. During generation on random values like when calling <code>nextInt</code> no internal state is being mutated. It is expected to chain such operations with combinators like <code>flatMap</code>. To preserve the same values generated between invocation of tests <code>setSeed</code> method can be used. It is guaranteed to return the same sequence of values for any given seed.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test.assert</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment.TestRandom</span><br></span><span class="token-line"><span class="token plain">import zio.test.Assertion.equalTo</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">testM(&quot;Use setSeed to generate stable values&quot;) {</span><br></span><span class="token-line"><span class="token plain">  for {</span><br></span><span class="token-line"><span class="token plain">    _  &lt;- TestRandom.setSeed(27)</span><br></span><span class="token-line"><span class="token plain">    r1 &lt;- random.nextLong</span><br></span><span class="token-line"><span class="token plain">    r2 &lt;- random.nextLong</span><br></span><span class="token-line"><span class="token plain">    r3 &lt;- random.nextLong</span><br></span><span class="token-line"><span class="token plain">  } yield</span><br></span><span class="token-line"><span class="token plain">    assert(List(r1,r2,r3))(equalTo(List[Long](</span><br></span><span class="token-line"><span class="token plain">      -4947896108136290151L,</span><br></span><span class="token-line"><span class="token plain">      -5264020926839611059L,</span><br></span><span class="token-line"><span class="token plain">      -9135922664019402287L</span><br></span><span class="token-line"><span class="token plain">    )))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res4: ZSpec[TestRandom with random.package.Random, Nothing] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;Use setSeed to generate stable values&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,176)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In second mode <code>TestRandom</code> maintains an internal buffer of values that can be &quot;fed&quot; upfront with methods such as <code>feedInts</code>. When random values are being generated first values from that buffer are being used.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test.environment.TestRandom</span><br></span><span class="token-line"><span class="token plain">testM(&quot;One can provide its own list of ints&quot;) {</span><br></span><span class="token-line"><span class="token plain">  for {</span><br></span><span class="token-line"><span class="token plain">    _  &lt;- TestRandom.feedInts(1, 9, 2, 8, 3, 7, 4, 6, 5)</span><br></span><span class="token-line"><span class="token plain">    r1 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r2 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r3 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r4 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r5 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r6 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r7 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r8 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">    r9 &lt;- random.nextInt</span><br></span><span class="token-line"><span class="token plain">  } yield assert(</span><br></span><span class="token-line"><span class="token plain">    List(1, 9, 2, 8, 3, 7, 4, 6, 5)</span><br></span><span class="token-line"><span class="token plain">  )(equalTo(List(r1, r2, r3, r4, r5, r6, r7, r8, r9)))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res5: ZSpec[TestRandom with random.package.Random, Nothing] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;One can provide its own list of ints&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,197)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When we run out of values in buffer <code>TestRandom</code> it falls back to first mode. If we want to we can also clear internal buffers by calling method
like <code>clearInts</code>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="testing-clock">Testing Clock<a aria-hidden="true" class="hash-link" href="#testing-clock" title="Direct link to heading">â€‹</a></h3><p>In most cases you want unit tests to be as fast as possible. Waiting for real time to pass by is a real killer for  this. ZIO exposes a <code>TestClock</code> in <code>TestEnvironment</code> that can control time so we can deterministically and efficiently  test effects involving the passage of time without actually having to wait for the full amount of time to pass. Calls to <code>sleep</code> and methods derived from it will semantically block until the clock time is set/adjusted to on or after the time the effect is scheduled to run. </p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="clock-time">Clock Time<a aria-hidden="true" class="hash-link" href="#clock-time" title="Direct link to heading">â€‹</a></h4><p>Clock time is just like a clock on the wall, except that in our <code>TestClock</code>, the clock is broken Instead of moving by itself, the clock time only changes when adjusted or set by the user, using the <code>adjust</code> and <code>setTime</code> methods. The clock time never changes by itself. When the clock is adjusted, any effects scheduled to run on or before the new clock time will automatically be run, in order.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="examples">Examples<a aria-hidden="true" class="hash-link" href="#examples" title="Direct link to heading">â€‹</a></h4><p><strong>Example 1</strong></p><p>Thanks to the call to <code>TestClock.adjust(1.minute)</code> we moved the time instantly 1 minute.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import java.util.concurrent.TimeUnit</span><br></span><span class="token-line"><span class="token plain">import zio.clock.currentTime</span><br></span><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain">import zio.test.Assertion.isGreaterThanEqualTo</span><br></span><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment.TestClock</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">testM(&quot;One can move time very fast&quot;) {</span><br></span><span class="token-line"><span class="token plain">  for {</span><br></span><span class="token-line"><span class="token plain">    startTime &lt;- currentTime(TimeUnit.SECONDS)</span><br></span><span class="token-line"><span class="token plain">    _         &lt;- TestClock.adjust(1.minute)</span><br></span><span class="token-line"><span class="token plain">    endTime   &lt;- currentTime(TimeUnit.SECONDS)</span><br></span><span class="token-line"><span class="token plain">  } yield assert(endTime - startTime)(isGreaterThanEqualTo(60L))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res6: ZSpec[TestClock with Clock, Nothing] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;One can move time very fast&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,236)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>Example 2</strong></p><p><code>TestClock</code> affects also all code running asynchronously that is scheduled to run after a certain time.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain">import zio.test.Assertion.equalTo</span><br></span><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment.TestClock</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">testM(&quot;One can control time as he see fit&quot;) {</span><br></span><span class="token-line"><span class="token plain">  for {</span><br></span><span class="token-line"><span class="token plain">    promise &lt;- Promise.make[Unit, Int]</span><br></span><span class="token-line"><span class="token plain">    _       &lt;- (ZIO.sleep(10.seconds) *&gt; promise.succeed(1)).fork</span><br></span><span class="token-line"><span class="token plain">    _       &lt;- TestClock.adjust(10.seconds)</span><br></span><span class="token-line"><span class="token plain">    readRef &lt;- promise.await</span><br></span><span class="token-line"><span class="token plain">  } yield assert(1)(equalTo(readRef))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res7: ZSpec[Clock with TestClock, Unit] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;One can control time as he see fit&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,260)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above code creates a write once cell that will be set to &quot;1&quot; after 10 seconds asynchronously from a different thread thanks to call to <code>fork</code>. At the end we wait on the promise until it is set. With call to <code>TestClock.adjust(10.seconds)</code> we simulate passing of 10 seconds of time. Because of it we don&#x27;t need to wait for the real 10 seconds to pass and thus our unit test can run faster This is a pattern that will very often be used when <code>sleep</code> and <code>TestClock</code> are being used for testing of effects that are based on time. The fiber that needs to sleep will be forked and <code>TestClock</code> will used to adjust the time so that all expected effects are run in the forked fiber.</p><p><strong>Example 3</strong></p><p>A more complex example leveraging layers and multiple services is shown below. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.clock.Clock</span><br></span><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain">import zio.test.Assertion._</span><br></span><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment.{ TestClock, TestEnvironment }</span><br></span><span class="token-line"><span class="token plain">import zio._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">trait SchedulingService {</span><br></span><span class="token-line"><span class="token plain">  def schedule(promise: Promise[Unit, Int]): ZIO[Any, Exception, Boolean]</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">trait LoggingService {</span><br></span><span class="token-line"><span class="token plain">  def log(msg: String): ZIO[Any, Exception, Unit]</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val schedulingLayer: ZLayer[Clock with Has[LoggingService], Nothing, Has[SchedulingService]] =</span><br></span><span class="token-line"><span class="token plain">  ZLayer.fromFunction { env =&gt;</span><br></span><span class="token-line"><span class="token plain">    new SchedulingService {</span><br></span><span class="token-line"><span class="token plain">      def schedule(promise: Promise[Unit, Int]): ZIO[Any, Exception, Boolean] =</span><br></span><span class="token-line"><span class="token plain">        (ZIO.sleep(10.seconds) *&gt; promise.succeed(1))</span><br></span><span class="token-line"><span class="token plain">          .tap(b =&gt; ZIO.service[LoggingService].flatMap(_.log(b.toString)))</span><br></span><span class="token-line"><span class="token plain">          .provide(env)</span><br></span><span class="token-line"><span class="token plain">    }</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// schedulingLayer: ZLayer[Clock with Has[LoggingService], Nothing, Has[SchedulingService]] = Managed(</span><br></span><span class="token-line"><span class="token plain">//   self = zio.ZManaged$$anon$2@6d7c1752</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">testM(&quot;One can control time for failing effects too&quot;) {</span><br></span><span class="token-line"><span class="token plain">  val failingLogger = ZLayer.succeed(new LoggingService {</span><br></span><span class="token-line"><span class="token plain">    override def log(msg: String): ZIO[Any, Exception, Unit] = ZIO.fail(new Exception(&quot;BOOM&quot;))</span><br></span><span class="token-line"><span class="token plain">  })</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">  val partialLayer = (ZLayer.identity[Clock] ++ failingLogger) &gt;&gt;&gt; schedulingLayer</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">  val testCase =</span><br></span><span class="token-line"><span class="token plain">    for {</span><br></span><span class="token-line"><span class="token plain">      promise &lt;- Promise.make[Unit, Int]</span><br></span><span class="token-line"><span class="token plain">      result  &lt;- ZIO.service[SchedulingService].flatMap(_.schedule(promise)).run.fork</span><br></span><span class="token-line"><span class="token plain">      _       &lt;- TestClock.adjust(10.seconds)</span><br></span><span class="token-line"><span class="token plain">      readRef &lt;- promise.await</span><br></span><span class="token-line"><span class="token plain">      result  &lt;- result.join</span><br></span><span class="token-line"><span class="token plain">    } yield assert(1)(equalTo(readRef)) &amp;&amp; assert(result)(fails(isSubtype[Exception](anything)))</span><br></span><span class="token-line"><span class="token plain">  testCase.provideSomeLayer[TestEnvironment](partialLayer)</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res9: ZSpec[TestEnvironment, Unit] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;One can control time for failing effects too&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,315)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this case we want to test a layered effect that can potentially fail with an error. To do this we need to run the effect
and use assertions that expect an <code>Exit</code> value.
Because we are providing a layer to the test we need to provide everything expected by our test case and leave the test
environment behind using <code>.provideSomeLayer[TestEnvironment]</code>. Keep in mind we do not provide any implementation of the <code>Clock</code>
because doing will make force <code>SchedulingService</code> to use it, while the clock we need here is the <code>TestClock</code> provided by
the test environment.</p><p>The pattern with <code>Promise</code> and <code>await</code> can be generalized when we need to wait for multiple values using a <code>Queue</code>. We simply need to put multiple values into the queue and progress the clock multiple times and there is no need to create multiple promises. Even if you have a non-trivial flow of data from multiple streams that can produce at different intervals and would like to test snapshots of data in particular point in time <code>Queue</code> can help with that.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain">import zio.test.Assertion.equalTo</span><br></span><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment.TestClock</span><br></span><span class="token-line"><span class="token plain">import zio.stream._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">testM(&quot;zipWithLatest&quot;) {</span><br></span><span class="token-line"><span class="token plain">  val s1 = Stream.iterate(0)(_ + 1).fixed(100.milliseconds)</span><br></span><span class="token-line"><span class="token plain">  val s2 = Stream.iterate(0)(_ + 1).fixed(70.milliseconds)</span><br></span><span class="token-line"><span class="token plain">  val s3 = s1.zipWithLatest(s2)((_, _))</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">  for {</span><br></span><span class="token-line"><span class="token plain">    q      &lt;- Queue.unbounded[(Int, Int)]</span><br></span><span class="token-line"><span class="token plain">    _      &lt;- s3.foreach(q.offer).fork</span><br></span><span class="token-line"><span class="token plain">    fiber  &lt;- ZIO.collectAll(ZIO.replicate(4)(q.take)).fork</span><br></span><span class="token-line"><span class="token plain">    _      &lt;- TestClock.adjust(1.second)</span><br></span><span class="token-line"><span class="token plain">    result &lt;- fiber.join</span><br></span><span class="token-line"><span class="token plain">  } yield assert(result)(equalTo(List(0 -&gt; 0, 0 -&gt; 1, 1 -&gt; 1, 1 -&gt; 2)))</span><br></span><span class="token-line"><span class="token plain">}</span><br></span><span class="token-line"><span class="token plain">// res10: ZSpec[Any with Clock with TestClock, Nothing] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;zipWithLatest&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//         test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//         annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,352)))</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="testing-console">Testing Console<a aria-hidden="true" class="hash-link" href="#testing-console" title="Direct link to heading">â€‹</a></h3><p><code>TestConsole</code> allows testing of applications that interact with console by modeling working with standard input and output
as writing and reading to and from internal buffers.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.test.environment.TestConsole</span><br></span><span class="token-line"><span class="token plain">import zio.console</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val consoleSuite = suite(&quot;ConsoleTest&quot;)(</span><br></span><span class="token-line"><span class="token plain">  testM(&quot;One can test output of console&quot;) {</span><br></span><span class="token-line"><span class="token plain">    for {</span><br></span><span class="token-line"><span class="token plain">      _              &lt;- TestConsole.feedLines(&quot;Jimmy&quot;, &quot;37&quot;)</span><br></span><span class="token-line"><span class="token plain">      _              &lt;- console.putStrLn(&quot;What is your name?&quot;)</span><br></span><span class="token-line"><span class="token plain">      name           &lt;- console.getStrLn</span><br></span><span class="token-line"><span class="token plain">      _              &lt;- console.putStrLn(&quot;What is your age?&quot;)</span><br></span><span class="token-line"><span class="token plain">      age            &lt;- console.getStrLn.map(_.toInt)</span><br></span><span class="token-line"><span class="token plain">      questionVector &lt;- TestConsole.output</span><br></span><span class="token-line"><span class="token plain">      q1             = questionVector(0)</span><br></span><span class="token-line"><span class="token plain">      q2             = questionVector(1)</span><br></span><span class="token-line"><span class="token plain">    } yield {</span><br></span><span class="token-line"><span class="token plain">      assert(name)(equalTo(&quot;Jimmy&quot;)) &amp;&amp;</span><br></span><span class="token-line"><span class="token plain">      assert(age)(equalTo(37)) &amp;&amp;</span><br></span><span class="token-line"><span class="token plain">      assert(q1)(equalTo(&quot;What is your name?\n&quot;)) &amp;&amp;</span><br></span><span class="token-line"><span class="token plain">      assert(q2)(equalTo(&quot;What is your age?\n&quot;))</span><br></span><span class="token-line"><span class="token plain">    }</span><br></span><span class="token-line"><span class="token plain">  }</span><br></span><span class="token-line"><span class="token plain">)</span><br></span><span class="token-line"><span class="token plain">// consoleSuite: Spec[console.package.Console with TestConsole, TestFailure[java.io.IOException], TestSuccess] = Spec(</span><br></span><span class="token-line"><span class="token plain">//   caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//     label = &quot;ConsoleTest&quot;,</span><br></span><span class="token-line"><span class="token plain">//     spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//       caseValue = MultipleCase(</span><br></span><span class="token-line"><span class="token plain">//         specs = IndexedSeq(</span><br></span><span class="token-line"><span class="token plain">//           Spec(</span><br></span><span class="token-line"><span class="token plain">//             caseValue = LabeledCase(</span><br></span><span class="token-line"><span class="token plain">//               label = &quot;One can test output of console&quot;,</span><br></span><span class="token-line"><span class="token plain">//               spec = Spec(</span><br></span><span class="token-line"><span class="token plain">//                 caseValue = TestCase(</span><br></span><span class="token-line"><span class="token plain">//                   test = &lt;function1&gt;,</span><br></span><span class="token-line"><span class="token plain">//                   annotations = Map(zio.test.TestAnnotation@fa40ba79 -&gt; List(SourceLocation(test_effects.md,377)))</span><br></span><span class="token-line"><span class="token plain">//                 )</span><br></span><span class="token-line"><span class="token plain">//               )</span><br></span><span class="token-line"><span class="token plain">//             )</span><br></span><span class="token-line"><span class="token plain">//           )</span><br></span><span class="token-line"><span class="token plain">//         )</span><br></span><span class="token-line"><span class="token plain">//       )</span><br></span><span class="token-line"><span class="token plain">//     )</span><br></span><span class="token-line"><span class="token plain">//   )</span><br></span><span class="token-line"><span class="token plain">// )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Above code simulates an application that will ask for name and age of the user. To test it we prefill buffers with answers
with call to <code>TestConsole.feedLines</code> method. Calls to <code>console.getStrLn</code> will get the value from the buffers instead of
interacting with the users keyboard. Also all output that our program produces by calling <code>console.putStrLn</code> (and other
printing methods) is being gathered and can be accessed with call to <code>TestConsole.output</code>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="testing-system">Testing System<a aria-hidden="true" class="hash-link" href="#testing-system" title="Direct link to heading">â€‹</a></h3><p>With increased usage of containers and runtimes like Kubernetes more and more applications are being configured by means
of environment variables. It is important to test this logic just like other parts of application. For this purpose <code>zio-test</code>
exposes <code>TestSystem</code> module. Additionally to setting the environment variables it also allows for setting JVM system properties
like in the code below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.system</span><br></span><span class="token-line"><span class="token plain">import zio.test.environment._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">for {</span><br></span><span class="token-line"><span class="token plain">  _      &lt;- TestSystem.putProperty(&quot;java.vm.name&quot;, &quot;VM&quot;)</span><br></span><span class="token-line"><span class="token plain">  result &lt;- system.property(&quot;java.vm.name&quot;)</span><br></span><span class="token-line"><span class="token plain">} yield assert(result)(equalTo(Some(&quot;VM&quot;)))</span><br></span><span class="token-line"><span class="token plain">// res11: ZIO[TestSystem with system.package.System, Throwable, TestResult] = zio.ZIO$FlatMap@7f5e19bc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It is worth noticing that no actual environment variables or properties will be set during testing so there will be
no impact on other parts of the system.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="test-aspects">Test Aspects<a aria-hidden="true" class="hash-link" href="#test-aspects" title="Direct link to heading">â€‹</a></h2><p>Test aspects are used to modify existing tests or even entire suites that you have already created. Test aspects are
applied to a test or suite using the <code>@@</code> operator. This is an example test suite showing the use of aspects to modify
test behavior:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain">import zio.test.Assertion._</span><br></span><span class="token-line"><span class="token plain">import zio.test.TestAspect._</span><br></span><span class="token-line"><span class="token plain">import zio.test._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">object MySpec extends DefaultRunnableSpec {</span><br></span><span class="token-line"><span class="token plain">  def spec = suite(&quot;A Suite&quot;)(</span><br></span><span class="token-line"><span class="token plain">    test(&quot;A passing test&quot;) {</span><br></span><span class="token-line"><span class="token plain">      assert(true)(isTrue)</span><br></span><span class="token-line"><span class="token plain">    },</span><br></span><span class="token-line"><span class="token plain">    test(&quot;A passing test run for JVM only&quot;) {</span><br></span><span class="token-line"><span class="token plain">      assert(true)(isTrue)</span><br></span><span class="token-line"><span class="token plain">    } @@ jvmOnly, //@@ jvmOnly only runs tests on the JVM</span><br></span><span class="token-line"><span class="token plain">    test(&quot;A passing test run for JS only&quot;) {</span><br></span><span class="token-line"><span class="token plain">      assert(true)(isTrue)</span><br></span><span class="token-line"><span class="token plain">    } @@ jsOnly, //@@ jsOnly only runs tests on Scala.js</span><br></span><span class="token-line"><span class="token plain">    test(&quot;A passing test with a timeout&quot;) {</span><br></span><span class="token-line"><span class="token plain">      assert(true)(isTrue)</span><br></span><span class="token-line"><span class="token plain">    } @@ timeout(10.nanos), //@@ timeout will fail a test that doesn&#x27;t pass within the specified time</span><br></span><span class="token-line"><span class="token plain">    test(&quot;A failing test... that passes&quot;) {</span><br></span><span class="token-line"><span class="token plain">      assert(true)(isFalse)</span><br></span><span class="token-line"><span class="token plain">    } @@ failing, //@@ failing turns a failing test into a passing test</span><br></span><span class="token-line"><span class="token plain">    test(&quot;A ignored test&quot;) {</span><br></span><span class="token-line"><span class="token plain">      assert(false)(isTrue)</span><br></span><span class="token-line"><span class="token plain">    } @@ ignore, //@@ ignore marks test as ignored</span><br></span><span class="token-line"><span class="token plain">    test(&quot;A flaky test that only works on the JVM and sometimes fails; let&#x27;s compose some aspects!&quot;) {</span><br></span><span class="token-line"><span class="token plain">      assert(false)(isTrue)</span><br></span><span class="token-line"><span class="token plain">    } @@ jvmOnly           // only run on the JVM</span><br></span><span class="token-line"><span class="token plain">      @@ eventually        //@@ eventually retries a test indefinitely until it succeeds</span><br></span><span class="token-line"><span class="token plain">      @@ timeout(20.nanos) //it&#x27;s a good idea to compose `eventually` with `timeout`, or the test may never end</span><br></span><span class="token-line"><span class="token plain">  ) @@ timeout(60.seconds)   //apply a timeout to the whole suite</span><br></span><span class="token-line"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zio/zio/edit/series/2.x/versioned_docs/version-1.x/howto/test_effects.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/version-1.x/howto/use-test-assertions"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->How to Use Test Assertions</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/version-1.x/howto/mock-services"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How to Mock Services?<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-zio-test-was-designed" class="table-of-contents__link toc-highlight">How zio-test was designed</a></li><li><a href="#constructing-tests" class="table-of-contents__link toc-highlight">Constructing tests</a><ul><li><a href="#assertions---creating-testresults" class="table-of-contents__link toc-highlight">Assertions - creating TestResults</a></li><li><a href="#running-tests" class="table-of-contents__link toc-highlight">Running tests</a></li></ul></li><li><a href="#using-test-environment" class="table-of-contents__link toc-highlight">Using Test Environment</a><ul><li><a href="#testing-random" class="table-of-contents__link toc-highlight">Testing Random</a></li><li><a href="#testing-clock" class="table-of-contents__link toc-highlight">Testing Clock</a></li><li><a href="#testing-console" class="table-of-contents__link toc-highlight">Testing Console</a></li><li><a href="#testing-system" class="table-of-contents__link toc-highlight">Testing System</a></li></ul></li><li><a href="#test-aspects" class="table-of-contents__link toc-highlight">Test Aspects</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item">
                <img src="/img/navbar_brand.png" alt="zio">
            </li></ul></div><div class="col footer__col"><div class="footer__title">Github</div><ul class="footer__items"><li class="footer__item">
              <a href="https://github.com/zio/zio">
                <img src="https://img.shields.io/github/stars/zio/zio?style=social" alt="github">
              </a>
            </li></ul></div><div class="col footer__col"><div class="footer__title">Chat with us on Discord</div><ul class="footer__items"><li class="footer__item">
                <a href="https://discord.gg/2ccFBr4">
                  <img src="https://img.shields.io/discord/629491597070827530?logo=discord&style=social" alt="discord">
                </a>
              </li></ul></div><div class="col footer__col"><div class="footer__title">Follow us on Twitter</div><ul class="footer__items"><li class="footer__item">
                <a href="https://twitter.com/zioscala">
                  <img src="https://img.shields.io/twitter/follow/zioscala?label=Follow&style=social" alt="twitter">
                </a>
              </li></ul></div><div class="col footer__col"><div class="footer__title">Additional resources</div><ul class="footer__items"><li class="footer__item"><a href="https://javadoc.io/doc/dev.zio/zio_2.12/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Scaladoc of ZIO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 ZIO Maintainers - Built with <a href="https://v2.docusaurus.io/">Docusaurus v2</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.a9287c7c.js"></script>
<script src="/assets/js/main.d278da23.js"></script>
</body>
</html>