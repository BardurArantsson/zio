<!doctype html>
<html class="docs-version-1.x" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="search" type="application/opensearchdescription+xml" title="ZIO" href="/opensearch.xml">
<link rel="stylesheet" href="/css/prism/prism-material-dark.css"><title data-react-helmet="true">TReentrantLock | ZIO</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zio.dev/version-1.x/datatypes/stm/treentrantlock"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="1.x"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-1.x"><meta data-react-helmet="true" property="og:title" content="TReentrantLock | ZIO"><meta data-react-helmet="true" name="description" content="A TReentrantLock allows safe concurrent access to some mutable state efficiently, allowing multiple fibers to read the"><meta data-react-helmet="true" property="og:description" content="A TReentrantLock allows safe concurrent access to some mutable state efficiently, allowing multiple fibers to read the"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://zio.dev/version-1.x/datatypes/stm/treentrantlock"><link data-react-helmet="true" rel="alternate" href="https://zio.dev/version-1.x/datatypes/stm/treentrantlock" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zio.dev/version-1.x/datatypes/stm/treentrantlock" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.f4d50625.css">
<link rel="preload" href="/assets/js/runtime~main.2ca2038d.js" as="script">
<link rel="preload" href="/assets/js/main.d278da23.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/navbar_brand.png" alt="ZIO" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/navbar_brand.png" alt="ZIO" class="themedImage_TMUO themedImage--dark_uzRr"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/version-1.x/overview/overview_index">Overview</a><a class="navbar__item navbar__link" href="/version-1.x/datatypes/index">Data Types</a><a class="navbar__item navbar__link" href="/version-1.x/usecases/usecases_index">Use Cases</a><a class="navbar__item navbar__link" href="/version-1.x/howto/index">How to</a><a class="navbar__item navbar__link" href="/version-1.x/resources/index">Resources</a><a class="navbar__item navbar__link" href="/version-1.x/about/about_index">About</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/version-1.x/overview/overview_index">ZIO 1.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/next/datatypes/stm/treentrantlock">ZIO 2.x (WIP)</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/version-1.x/datatypes/stm/treentrantlock">ZIO 1.x</a></li></ul></div><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Core Data Types</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Contextual Types</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Fiber Primitives</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concurrency Primitives</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">STM</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/index">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/stm">STM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tarray">TArray</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tset">TSet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tmap">TMap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tref">TRef</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tpriorityqueue">TPriorityQueue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tpromise">TPromise</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tqueue">TQueue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/version-1.x/datatypes/stm/treentrantlock">TReentrantLock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/version-1.x/datatypes/stm/tsemaphore">TSemaphore</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Resource Safety</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Streaming</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Miscellaneous</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->ZIO 1.x</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>TReentrantLock</h1></header><p>A TReentrantLock allows safe concurrent access to some mutable state efficiently, allowing multiple fibers to read the
state (because that is safe to do) but only one fiber to modify the state (to prevent data corruption). Also, even though
the TReentrantLock is implemented using STM; reads and writes can be committed, allowing this to be used as a building
block for solutions that expose purely ZIO effects and internally allow locking on more than one piece of state in a
simple and composable way (thanks to STM).</p><p>A <code>TReentrantLock</code> is a <em>reentrant</em> read/write lock. A reentrant lock is one where a fiber can claim the lock multiple
times without blocking on itself. It&#x27;s useful in situations where it&#x27;s not easy to keep track of whether you have already
grabbed a lock. If a lock is non re-entrant you could grab the lock, then block when you go to grab it again, effectively
causing a deadlock. </p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="semantics">Semantics<a aria-hidden="true" class="hash-link" href="#semantics" title="Direct link to heading">â€‹</a></h2><p>This lock allows both readers and writers to reacquire read or write locks with reentrancy guarantees. Readers are not
allowed until all write locks held by the writing fiber have been released. Writers are not allowed unless there are no
other locks or the fiber wanting to hold a write lock already has a read lock and there are no other fibers holding a
read lock. </p><p>This lock also allows upgrading from a read lock to a write lock (automatically) and downgrading
from a write lock to a read lock (automatically provided that you upgraded from a read lock to a write lock).</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="creating-a-reentrant-lock">Creating a reentrant lock<a aria-hidden="true" class="hash-link" href="#creating-a-reentrant-lock" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.stm._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val reentrantLock = TReentrantLock.make</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="acquiring-a-read-lock">Acquiring a read lock<a aria-hidden="true" class="hash-link" href="#acquiring-a-read-lock" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio.stm._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val program =</span><br></span><span class="token-line"><span class="token plain">  (for {</span><br></span><span class="token-line"><span class="token plain">    lock &lt;- TReentrantLock.make</span><br></span><span class="token-line"><span class="token plain">    _    &lt;- lock.acquireRead</span><br></span><span class="token-line"><span class="token plain">    rst  &lt;- lock.readLocked  // lock is read-locked once transaction completes</span><br></span><span class="token-line"><span class="token plain">    wst  &lt;- lock.writeLocked // lock is not write-locked</span><br></span><span class="token-line"><span class="token plain">  } yield rst &amp;&amp; !wst).commit</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="acquiring-a-write-lock">Acquiring a write lock<a aria-hidden="true" class="hash-link" href="#acquiring-a-write-lock" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio._</span><br></span><span class="token-line"><span class="token plain">import zio.stm._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val writeLockProgram: UIO[Boolean] =</span><br></span><span class="token-line"><span class="token plain">  (for {</span><br></span><span class="token-line"><span class="token plain">    lock &lt;- TReentrantLock.make</span><br></span><span class="token-line"><span class="token plain">    _    &lt;- lock.acquireWrite</span><br></span><span class="token-line"><span class="token plain">    wst  &lt;- lock.writeLocked // lock is write-locked once transaction completes</span><br></span><span class="token-line"><span class="token plain">    rst  &lt;- lock.readLocked  // lock is not read-locked</span><br></span><span class="token-line"><span class="token plain">  } yield !rst &amp;&amp; wst).commit</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="multiple-fibers-can-hold-read-locks">Multiple fibers can hold read locks<a aria-hidden="true" class="hash-link" href="#multiple-fibers-can-hold-read-locks" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio._</span><br></span><span class="token-line"><span class="token plain">import zio.stm._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val multipleReadLocksProgram: UIO[(Int, Int)] = for {</span><br></span><span class="token-line"><span class="token plain">  lock          &lt;- TReentrantLock.make.commit</span><br></span><span class="token-line"><span class="token plain">  fiber0        &lt;- lock.acquireRead.commit.fork // fiber0 acquires a read-lock</span><br></span><span class="token-line"><span class="token plain">  currentState1 &lt;- fiber0.join                  // 1 read lock held</span><br></span><span class="token-line"><span class="token plain">  fiber1        &lt;- lock.acquireRead.commit.fork // fiber1 acquires a read-lock</span><br></span><span class="token-line"><span class="token plain">  currentState2 &lt;- fiber1.join                  // 2 read locks held </span><br></span><span class="token-line"><span class="token plain">} yield (currentState1, currentState2)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="upgrading-and-downgrading-locks">Upgrading and downgrading locks<a aria-hidden="true" class="hash-link" href="#upgrading-and-downgrading-locks" title="Direct link to heading">â€‹</a></h2><p>If your fiber already has a read lock then it is possible to upgrade the lock to a write lock provided that no other
reader (other than your fiber) holds a lock</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio._</span><br></span><span class="token-line"><span class="token plain">import zio.stm._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val upgradeDowngradeProgram: UIO[(Boolean, Boolean, Boolean, Boolean)] = for {</span><br></span><span class="token-line"><span class="token plain">  lock               &lt;- TReentrantLock.make.commit</span><br></span><span class="token-line"><span class="token plain">  _                  &lt;- lock.acquireRead.commit</span><br></span><span class="token-line"><span class="token plain">  _                  &lt;- lock.acquireWrite.commit  // upgrade</span><br></span><span class="token-line"><span class="token plain">  isWriteLocked      &lt;- lock.writeLocked.commit   // now write-locked</span><br></span><span class="token-line"><span class="token plain">  isReadLocked       &lt;- lock.readLocked.commit    // and read-locked</span><br></span><span class="token-line"><span class="token plain">  _                  &lt;- lock.releaseWrite.commit  // downgrade</span><br></span><span class="token-line"><span class="token plain">  isWriteLockedAfter &lt;- lock.writeLocked.commit   // no longer write-locked</span><br></span><span class="token-line"><span class="token plain">  isReadLockedAfter  &lt;- lock.readLocked.commit    // still read-locked</span><br></span><span class="token-line"><span class="token plain">} yield (isWriteLocked, isReadLocked, isWriteLockedAfter, isReadLockedAfter)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="acquiring-a-write-lock-in-a-contentious-scenario">Acquiring a write lock in a contentious scenario<a aria-hidden="true" class="hash-link" href="#acquiring-a-write-lock-in-a-contentious-scenario" title="Direct link to heading">â€‹</a></h2><p>A write lock can be acquired immediately only if one of the following conditions are satisfied:</p><ol><li>There are no other holders of the lock</li><li>The current fiber is already holding a read lock and there are no other parties holding a read lock</li></ol><p>If either of the above scenarios are untrue then attempting to acquire a write lock will semantically block the fiber.
Here is an example which demonstrates that a write lock can only be obtained by the fiber once all other readers (except
the fiber attempting to acquire the write lock) have released their hold on the (read or write) lock.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio._</span><br></span><span class="token-line"><span class="token plain">import zio.clock._</span><br></span><span class="token-line"><span class="token plain">import zio.console._</span><br></span><span class="token-line"><span class="token plain">import zio.stm._</span><br></span><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val writeLockDemoProgram: URIO[Console with Clock, Unit] = for {</span><br></span><span class="token-line"><span class="token plain">  l  &lt;- TReentrantLock.make.commit</span><br></span><span class="token-line"><span class="token plain">  _  &lt;- putStrLn(&quot;Beginning test&quot;).orDie</span><br></span><span class="token-line"><span class="token plain">  f1 &lt;- (l.acquireRead.commit *&gt; ZIO.sleep(5.seconds) *&gt; l.releaseRead.commit).fork</span><br></span><span class="token-line"><span class="token plain">  f2 &lt;- (l.acquireRead.commit *&gt; putStrLn(&quot;read-lock&quot;).orDie *&gt; l.acquireWrite.commit *&gt; putStrLn(&quot;I have upgraded!&quot;).orDie).fork</span><br></span><span class="token-line"><span class="token plain">  _  &lt;- (f1 zip f2).join</span><br></span><span class="token-line"><span class="token plain">} yield ()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here fiber <code>f1</code> acquires a read lock and sleeps for 5 seconds before releasing it. Fiber <code>f2</code> also acquires a read
lock and immediately tries to acquire a write lock. However, <code>f2</code> will have to semantically block for approximately 5
seconds to obtain a write lock because <code>f1</code> will release its hold on the lock and only then can <code>f2</code> acquire a hold for
the write lock. </p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="safer-methods--readlock-and-writelock">Safer methods  (<code>readLock</code> and <code>writeLock</code>)<a aria-hidden="true" class="hash-link" href="#safer-methods--readlock-and-writelock" title="Direct link to heading">â€‹</a></h2><p>Using <code>acquireRead</code>, <code>acquireWrite</code>, <code>releaseRead</code> and <code>releaseWrite</code> should be avoided for simple use cases relying on
methods like <code>readLock</code> and <code>writeLock</code> instead. <code>readLock</code> and <code>writeLock</code> automatically acquire and release the lock
thanks to the <code>Managed</code> construct. The program described below is a safer version of the program above and ensures we
don&#x27;t hold onto any resources once we are done using the reentrant lock.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar"><code class="codeBlockLines_1zSZ"><span class="token-line"><span class="token plain">import zio._</span><br></span><span class="token-line"><span class="token plain">import zio.clock._</span><br></span><span class="token-line"><span class="token plain">import zio.console._</span><br></span><span class="token-line"><span class="token plain">import zio.stm._</span><br></span><span class="token-line"><span class="token plain">import zio.duration._</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">val saferProgram: URIO[Console with Clock, Unit] = for {</span><br></span><span class="token-line"><span class="token plain">  lock &lt;- TReentrantLock.make.commit</span><br></span><span class="token-line"><span class="token plain">  f1   &lt;- lock.readLock.use_(ZIO.sleep(5.seconds) *&gt; putStrLn(&quot;Powering down&quot;).orDie).fork</span><br></span><span class="token-line"><span class="token plain">  f2   &lt;- lock.readLock.use_(lock.writeLock.use_(putStrLn(&quot;Huzzah, writes are mine&quot;).orDie)).fork</span><br></span><span class="token-line"><span class="token plain">  _    &lt;- (f1 zip f2).join</span><br></span><span class="token-line"><span class="token plain">} yield ()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zio/zio/edit/series/2.x/versioned_docs/version-1.x/datatypes/stm/treentrantlock.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/version-1.x/datatypes/stm/tqueue"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->TQueue</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/version-1.x/datatypes/stm/tsemaphore"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">TSemaphore<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#semantics" class="table-of-contents__link toc-highlight">Semantics</a></li><li><a href="#creating-a-reentrant-lock" class="table-of-contents__link toc-highlight">Creating a reentrant lock</a></li><li><a href="#acquiring-a-read-lock" class="table-of-contents__link toc-highlight">Acquiring a read lock</a></li><li><a href="#acquiring-a-write-lock" class="table-of-contents__link toc-highlight">Acquiring a write lock</a></li><li><a href="#multiple-fibers-can-hold-read-locks" class="table-of-contents__link toc-highlight">Multiple fibers can hold read locks</a></li><li><a href="#upgrading-and-downgrading-locks" class="table-of-contents__link toc-highlight">Upgrading and downgrading locks</a></li><li><a href="#acquiring-a-write-lock-in-a-contentious-scenario" class="table-of-contents__link toc-highlight">Acquiring a write lock in a contentious scenario</a></li><li><a href="#safer-methods--readlock-and-writelock" class="table-of-contents__link toc-highlight">Safer methods  (<code>readLock</code> and <code>writeLock</code>)</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item">
                <img src="/img/navbar_brand.png" alt="zio">
            </li></ul></div><div class="col footer__col"><div class="footer__title">Github</div><ul class="footer__items"><li class="footer__item">
              <a href="https://github.com/zio/zio">
                <img src="https://img.shields.io/github/stars/zio/zio?style=social" alt="github">
              </a>
            </li></ul></div><div class="col footer__col"><div class="footer__title">Chat with us on Discord</div><ul class="footer__items"><li class="footer__item">
                <a href="https://discord.gg/2ccFBr4">
                  <img src="https://img.shields.io/discord/629491597070827530?logo=discord&style=social" alt="discord">
                </a>
              </li></ul></div><div class="col footer__col"><div class="footer__title">Follow us on Twitter</div><ul class="footer__items"><li class="footer__item">
                <a href="https://twitter.com/zioscala">
                  <img src="https://img.shields.io/twitter/follow/zioscala?label=Follow&style=social" alt="twitter">
                </a>
              </li></ul></div><div class="col footer__col"><div class="footer__title">Additional resources</div><ul class="footer__items"><li class="footer__item"><a href="https://javadoc.io/doc/dev.zio/zio_2.12/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Scaladoc of ZIO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 ZIO Maintainers - Built with <a href="https://v2.docusaurus.io/">Docusaurus v2</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.2ca2038d.js"></script>
<script src="/assets/js/main.d278da23.js"></script>
</body>
</html>